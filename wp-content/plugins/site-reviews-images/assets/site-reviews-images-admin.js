!function(){"use strict";var e=Backbone.Collection.extend({model:wp.media.model.Attachment,initialize:function(e,t){this.controller=t.controller||new e.Controller,this.on("add remove reset",(()=>this.controller.set("length",this.length)))},add:function(e,t){if(!e)return this;e.hasOwnProperty("length")?e instanceof wp.media.model.Attachments&&(e=e.models):e=[e],e=_.difference(e,this.models),Backbone.Collection.prototype.add.call(this,e,t)},destroyAll:function(){_.each(_.clone(this.models),(e=>e.destroy()))}});var t=Backbone.Model.extend({defaults:{ids:[],length:0},initialize:function(){this.set("ids",_.without(_.map(this.get("ids"),Number),0,-1)),this.set("items",new e([],{controller:this}))}}),i="site-reviews-images";const n=wp.media.controller.Library.extend({defaults:_.defaults({filterable:"uploaded",library:{search:i,type:"image"},multiple:"add",priority:100,searchable:!1,syncSelection:!1},wp.media.controller.Library.prototype.defaults),activate:function(){const e=this.get("library"),t=this.frame.options.edit;this.editLibrary&&this.editLibrary!==t&&e.unobserve(this.editLibrary),e.validator=function(e){return!!this.mirroring.get(e.cid)&&!t.get(e.cid)&&wp.media.model.Selection.prototype.validator.apply(this,arguments)},e.reset(e.mirroring.models,{silent:!0}),e.observe(t),this.editLibrary=t,wp.media.controller.Library.prototype.activate.apply(this,arguments)}});var o=n;var s=wp.media.view.MediaFrame.Select.extend({createStates:function(){const e=this.options;e.states||this.states.add([new o({library:wp.media.query(e.library),multiple:e.multiple,priority:20})])}});var l=Backbone.View.extend({className:"glsri-media-add",tagName:"div",template:wp.template("glsri-media-button"),events:{"click button":"onClick"},initialize:function(e){this.controller=e.controller,this.collection=this.controller.get("items"),this.render()},onClick:function(e){e.preventDefault(),this._frame&&this._frame.dispose(),this._frame=new s({edit:this.collection,editing:!0,library:{search:i,type:"image"},multiple:"add"}),this._frame.on("open",(()=>{const e=this._frame.content.get();e&&e.collection&&(e.collection.mirroring._hasMore=!0,e.collection.more())})),this._frame.on("select",(()=>{const e=this._frame.state().get("selection");this.collection.add(e.models)})),this._frame.open()},render:function(){return this.$el.html(this.template({text:GLSR.addons[i].text.add})),this}});const r=wp.media.view.Attachment.Details.TwoColumn.extend({render:function(){wp.media.view.Attachment.Details.prototype.render.apply(this,arguments),this.players=this.players||[],wp.media.mixin.unsetPlayers.call(this),this.$("audio, video").each(((e,t)=>{const i=wp.media.view.MediaDetails.prepareSrc(t);this.players.push(new window.MediaElementPlayer(i,wp.media.mixin.mejsSettings))}))}});var a=r;var c=wp.media.view.MediaFrame.EditAttachments.extend({editMetadataMode:function(e){e.view=new a({controller:this,model:this.model}),e.view.views.set(".attachment-compat",new wp.media.view.AttachmentCompat({controller:this,model:this.model}))},resetRoute:function(){}});var h=Backbone.View.extend({className:"glsri-media-item attachment",tagName:"div",template:wp.template("glsri-media-item"),events:{"click .glsri-edit-media":"onClickEdit","click .glsri-remove-media":"onClickRemove","click .glsri-switch-media":"onClickSwitch"},initialize:function(e){this.controller=e.controller,this.collection=this.controller.get("items"),this.render(),this.listenTo(this.model,"change",this.render),this.$el.data("id",this.model.cid)},onClickEdit:function(e){e.preventDefault(),this.trigger("click:edit",this.model)},onClickRemove:function(e){e.preventDefault(),this.trigger("click:remove",this.model)},onClickSwitch:function(e){e.preventDefault(),this.trigger("click:switch",this.model)},render:function(){var e=this.model.toJSON();return e.controller=this.controller.toJSON(),this.$el.html(this.template(e)),this}});var d=Backbone.View.extend({className:"glsri-media-list",tagName:"div",initialize:function(e){this.controller=e.controller,this.collection=this.controller.get("items"),this.itemView=h,this.getItemView=_.memoize((e=>{const t=new this.itemView({controller:this.controller,model:e});return this.listenToItemView(t),t}),(e=>e.cid)),this.listenTo(this.collection,"add",this.addItemView),this.listenTo(this.collection,"remove",this.removeItemView),this.listenTo(this.collection,"reset",this.resetItemViews),this.$el.sortable({helper:"clone"})},addItemView:function(e){const t=this.collection.indexOf(e),i=this.getItemView(e).el,n=this.$el.children();0>=t?this.$el.prepend(i):n.length<=t?this.$el.append(i):n.eq(t-1).after(i)},editItem:function(e){this._editFrame&&this._editFrame.dispose(),this._editFrame=new c({controller:{gridRouter:new wp.media.view.MediaFrame.Manage.Router},frame:"edit-attachments",library:this.collection,model:e}),this._editFrame.open()},listenToItemView:function(e){this.listenTo(e,"click:remove",this.removeItem),this.listenTo(e,"click:switch",this.switchItem),this.listenTo(e,"click:edit",this.editItem)},removeItem:function(e){this.collection.remove(e)},removeItemView:function(e){this.getItemView(e).$el.detach()},resetItemViews:function(e){_.each(that.models,this.removeItemView),e.each(this.addItemView)},switchItem:function(e){return this._switchFrame&&this._switchFrame.dispose(),this._switchFrame=new s({edit:this.collection,editing:!0,library:{search:i,type:"image"},multiple:!1}),this._switchFrame.on("open",(()=>{const e=this._switchFrame.content.get();e&&e.collection&&(e.collection.mirroring._hasMore=!0,e.collection.more())})),this._switchFrame.on("select",(()=>{const t=this._switchFrame.state().get("selection"),i=this.collection,n=i.indexOf(e);_.isEmpty(t)||(i.remove(e),i.add(t,{at:n}))})),this._switchFrame.open(),!1}});var m=Backbone.View.extend({className:"glsri-media-field",initialize:function(e){wp.media.model.Attachments.prototype.constructor.filters.search=()=>!0,this.$inputEl=jQuery(e.input);const i=_.extend({fieldName:e.input.name+"[]",ids:this.$inputEl.val().split(",")},this.$inputEl.data("options"));this.controller=new t(i),this.createList(),this.createAddButton(),this.render(),this.loadInitialAttachments();const n=this.controller.get("items");this.$inputEl.on("remove",(()=>this.controller.destroy())),this.$inputEl.on("media:reset",(()=>n.reset())),n.on("add remove reset",_.debounce((()=>{const e=n.pluck("id").join(",");this.$inputEl.val(e).trigger("change",[this.$(".glsri-media-input")])}),500))},createAddButton:function(){this.addButton=new l({controller:this.controller})},createList:function(){this.list=new d({controller:this.controller})},loadInitialAttachments:function(){if(this.$inputEl.val()){var e=this.$inputEl.data("attachments").map((e=>wp.media.model.Attachment.create(e)));this.controller.get("items").add(e)}},render:function(){this.$el.empty().append(this.list.el,this.addButton.el)}});jQuery((function(){jQuery(".glsri-media").each(((e,t)=>{const i=jQuery(t);let n=i.data("view");n||(n=new m({input:t}),i.siblings(".glsri-media-field").remove(),i.after(n.el),i.data("view",n))}))}))}();