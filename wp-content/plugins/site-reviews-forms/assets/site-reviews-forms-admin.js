!function(){"use strict";var e=GLSR.addons["site-reviews-forms"];function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},t(e)}function i(e){var i=function(e,i){if("object"!=t(e)||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var n=s.call(e,i||"default");if("object"!=t(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===i?String:Number)(e)}(e,"string");return"symbol"==t(i)?i:i+""}function s(e,t,s){return(t=i(t))in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}var n=function(e){return!(_.isNull(e)||_.isUndefined(e)||_.isString(e)&&""===jQuery.trim(e)||_.isArray(e)&&_.isEmpty(e))},o={between:function(t,i,s,o){if(n(t)&&(!jQuery.isNumeric(t)||+t<o[0]||+t>o[1]))return wp.i18n.sprintf(e.messages.between,e.labels[i],o[0],o[1])},criteria:function(t,i,s){var n=(t||"").split("|");if("always"!==n[0]&&1===n.length)return wp.i18n.sprintf(e.messages.criteria,e.labels[i])},number:function(t,i,s){if(n(t)&&!jQuery.isNumeric(t))return wp.i18n.sprintf(e.messages.number,e.labels[i])},required:function(t,i,s){if(!n(t))return wp.i18n.sprintf(e.messages.required,e.labels[i])},reserved:function(t,i,s){var n=s.get("type")||"",o=e["reserved_".concat(i,"s")]||[];return"review_"!==n.substring(0,7)&&~o.indexOf(t)||"name"===i&&~["_custom","custom_"].indexOf(t.substring(0,7))?wp.i18n.sprintf(e.messages.reserved,t):void 0},slug:function(t,i,s){if(new RegExp("[^a-z_]").test(t))return wp.i18n.sprintf(e.messages.slug,e.labels[i])},unique:function(t,i,o){var l=_.filter(o.collection.where(s({},i,t)),(function(e){return e.cid!==o.cid}));if(n(t)&&l.length)return wp.i18n.sprintf(e.messages.unique,e.labels[i])}},l=Backbone.Model.extend({defaults:{conditions:"always",description:"",expanded:!1,format:"",format_link_text:"",handle:"",hidden:!1,label:"",labels:{},maxlength:0,minlength:0,name:"",options:{},placeholder:"",required:!1,responsive_width:{sm:"",md:"",lg:"",xl:""},tag:"",tag_label:"",type:"text",value:""},errors:{},initialize:function(){this.set("handle",this.getDefaults().handle,{silent:!0})},getDefaults:function(t){t=t||this.get("type");var i=_.findWhere(e.defaults,{type:t})||{};return _.extend({},_.clone(this.defaults),i)},options:function(){var t=e.options[this.get("type")]||{};return this.get("hidden")&&(t=_.filter(t,(function(e){return"hidden"===e.substring(0,6)})),t=_.map(t,(function(e){return e.replace("hidden:","")}))),this.get("format")&&"link"!==this.get("format").substring(0,4)&&(t=_.filter(t,(function(e){return"format_link_text"!==e}))),t},reset:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];e&&this.set({hidden:!1},{silent:!0}),e=e||this.get("type");var i=this.get("hidden");this.clear({silent:!0});var s=_.extend({},this.getDefaults(e),{hidden:!!i});return this.set(s,{silent:!0,validate:t}),this},toggle:function(e){return this.set({expanded:e||!this.get("expanded")},{silent:!0,validate:!1}),this},validate:function(t){var i=this;this.errors={};var s=_.union(this.options(),["name","type"]),n=_.pick(e.validation[t.type],s);if(_.each(n,(function(e,s){_.each(e,(function(e,n){var l=o[n](t[s],s,i,e);l&&(i.errors[s]=l)}))})),!_.isEmpty(this.errors))return console.error(this.errors),!1}}),r=l,a=Backbone.Collection.extend({model:r}),d={classes:{active:"is-active",condition_add:"glsr-add-condition",condition_remove:"glsr-remove-condition",conditions:"glsr-criteria-conditions",criteria:"glsr-criteria",error:"glsrf-field-error",field_inner:"glsrf-field-inner",highlighted:"is-highlighted",input:"glsr-input",invalid:"is-invalid",mb:"glsr-search-multibox",mb_entries:"glsr-selected-entries",mb_entry:"glsr-multibox-entry",mb_input:"glsr-search-input",mb_remove:"glsr-remove-button",mb_result:"glsr-search-result",mb_results:"glsr-search-results",selected:"is-selected",settings:"glsrf-field-settings"},contains:function(e,t){return e.classList.contains(this.classes[t]||t)},encode:function(e){return JSON.stringify(e)},escapeHtml:function(e){return e.replace(/[&<>'"]/g,(function(e){return"&#"+e.charCodeAt(0)+";"}))},selector:function(e){return"."+this.classes[e]||0}},c=function(e){if(window.getSelection){var t=window.getSelection(),i=document.createRange();i.selectNodeContents(e),t.removeAllRanges(),t.addRange(i)}};function h(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,s)}return i}function f(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?h(Object(i),!0).forEach((function(t){s(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):h(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}var u=Backbone.View.extend({className:"glsr-criteria-condition",field:null,fields:null,template:wp.template("glsrf-criteria-condition"),events:{"change select[data-condition=fieldname]":"onChangeField","change select[data-condition=operator]":"onChange","change select[data-condition=value]":"onChange","keyup input[data-condition=value]":"onChange","click .glsr-remove-condition":"onRemove"},initialize:function(e){_.extend(this,_.pick(e,"field","fields")),this.listenTo(this.model,"destroy",this.remove),this.listenTo(this.model,"change:fieldname",this.render)},render:function(){return this.$el.html(this.template(this.data())),this},conditionFields:function(){return _.object(this.fields.filter(function(t){if(t.get("name")===this.field.get("name"))return!1;var i=_.get(e.criteria.restrictions,t.get("type"),{});return!_.isEmpty(_.values(i).filter((function(e){return!_.isEmpty(e)})))}.bind(this)).map((function(e){return[e.get("name"),e.get("label")||e.get("handle")]})))},conditionOperators:function(){var t=_.get(e.criteria.restrictions,this.fieldKey("type"),{});return _.pick(e.criteria.operators,t.operators||[])},conditionValues:function(){var t=_.get(e.criteria.restrictions,this.fieldKey("type"),{});return _.pick(e.criteria.values,t.values||[])},data:function(){var e,t,i=this.model.toJSON(),s=this.conditionFields(),n=this.conditionOperators(),o=this.conditionValues(),l=this.model.previous("fieldname");!_.isUndefined(l)&&i.fieldname!==l&&this.fields.findWhere({fieldname:l})&&(i.operator=null!==(e=_.keys(n).shift())&&void 0!==e?e:"",i.value=null!==(t=_.keys(o).shift())&&void 0!==t?t:"");return this.model.set(i,{silent:!0}),f(f({},i),{},{fields:s,operators:n,values:o})},fieldKey:function(e){return this.fields.findWhere({name:this.model.get("fieldname")}).get(e)},onChange:function(e){var t=e.target.dataset.condition,i=e.target.value;this.model.set(t,i)},onChangeField:function(e){this.onChange(e)},onRemove:function(e){e.preventDefault(),this.model.destroy()}}),g=Backbone.Model.extend({defaults:{fieldname:"",operator:"",value:""}}),p={Model:g,Collection:Backbone.Collection.extend({model:g}),View:u},m=Backbone.View.extend({conditions:null,key:null,selected:"",template:wp.template("glsrf-criteria"),events:{"change .glsr-criteria-option select":"onChangeCriteria","click .glsr-add-condition":"onAddCondition"},initialize:function(e){var t=this;_.extend(this,_.pick(e,"key")),this.conditions=new p.Collection,this.render(),this.listenTo(this.conditions,"add",this.update),this.listenTo(this.conditions,"change",this.update),this.listenTo(this.conditions,"remove",this.update),this.listenTo(this.model.collection,"field:save",this.onFieldSave),this.listenTo(this.model.collection,"remove",this.onFieldRemove),this.listenTo(this.model,"destroy",(function(){t.conditions.reset(),t.remove()}))},render:function(){var t=this;this.selected=this.model.get(this.key).split("|").shift()||"always";var i={cid:this.model.cid,conditions:e.criteria.conditions,key:this.key,selected:this.selected};if(this.$el.html(this.template(i)),"always"===this.selected)this.$(d.selector("condition_add")).hide();else{var s=this.model.get(this.key).split("|");s.shift(),_.map(s,(function(e){var i=_.object(["fieldname","operator","value"],e.split(":"));t.addCondition(i)}))}return this},addCondition:function(t){var i=this;if(!(2>this.model.collection.length)){if(_.isEmpty(t)){console.info(this.model),console.info(this.model.collection);var s=this.model.collection.filter((function(e){return e.get("name")!==i.model.get("name")})).shift(),n=_.get(e.criteria.restrictions,s.get("type"),[]),o=_.keys(_.pick(e.criteria.operators,n.operators)).shift();t={fieldname:s.get("name"),operator:o}}var l=new p.Model(t),r=new p.View({field:this.model,fields:this.model.collection,model:l});this.$(d.selector("conditions")).append(r.render().el),this.conditions.add(l)}},onAddCondition:function(e){e.preventDefault(),this.addCondition()},onChangeCriteria:function(e){this.selected=e.target.value;var t="always"===this.selected?"hide":"show",i=this.$(d.selector("conditions"));this.$(d.selector("condition_add"))[t](),i[t](),"show"!==t||i.children().length?this.update():this.addCondition()},onFieldRemove:function(e){this.conditions.length&&(this.conditions.where({fieldname:e.get("fieldname")}).forEach((function(e){return e.destroy()})),this.conditions.length||this.$(".glsr-criteria-option select").val("always").trigger("change"))},onFieldSave:function(e){if(this.conditions.length){var t=e.previous("fieldname"),i=e.get("fieldname");t!==i&&this.conditions.where({fieldname:t}).forEach((function(e){return e.set({fieldname:i})}))}},update:function(){var e=[this.selected];"always"===this.selected&&this.conditions.reset(),this.conditions.each((function(t){var i=t.toJSON();e.push(i.fieldname+":"+i.operator+":"+i.value)})),this.model.set(this.key,e.join("|"),{silent:!0,validate:!0}),this.model.trigger("model:validate:reset",this.el),this.model.trigger("tippy")}}),v=m,y=["Down","Enter","Esc","Up"],b=["Tab"],w=Backbone.View.extend({isActive:!1,key:null,options:[],template:wp.template("glsrf-multibox"),templateEntry:wp.template("glsrf-multibox-entry"),events:{"focus .glsr-search-input":"onFocusInside","input .glsr-search-input":"onSearch","click .glsr-remove-button":"onRemove","click .glsr-search-result":"onSelect","mouseleave .glsr-search-result":"onMouseleave","mouseover .glsr-search-result":"onMouseover"},initialize:function(e){_.extend(this,_.pick(e,"key","options")),this.render(),this.listenTo(this.model,"multibox:keydown",this.onKeydown),this.listenTo(this.model,"multibox:keyup",this.onKeyup),this.listenTo(this.model,"destroy",this.remove),this.listenTo(this.model.collection,"doc:click",this.onClickOutside)},render:function(){this.$el.html(this.template({cid:this.model.cid,key:this.key,options:this.options})),this.refreshDOM()},filterEntries:function(){var e=this,t=this.model.get(this.key)||[],i=this.$(d.selector("mb_input")).val();this.$(d.selector("mb_result")).each((function(s,n){var o=e.$(n),l=~t.indexOf(o.data("slug")),r=-1===o.text().toLowerCase().indexOf(i.toLowerCase());o[l||r?"hide":"show"]()}))},keydownDown:function(e){(d.contains(e.target,"mb_input")||d.contains(e.target,"mb_result"))&&(e.preventDefault(),this.navigateDown())},keydownEnter:function(e){var t=this.$(e.target);if(t.length)if(t.hasClass(d.classes.mb_remove))this.removeSelected(t);else{var i=this.$(d.selector("mb_result")+d.selector("highlighted"));this.selectOption(i)}},keydownEsc:function(e){this.multiboxClose()},keydownUp:function(e){(d.contains(e.target,"mb_input")||d.contains(e.target,"mb_result"))&&(e.preventDefault(),this.navigateUp())},keyupTab:function(e){if(d.contains(e.target,"mb_input"))this.multiboxOpen();else{var t=this.$el.closest(".glsr-metabox-field")[e.originalEvent.shiftKey?"prev":"next"](".glsr-metabox-field").find(":focusable");this.isActive&&t[0]&&t[0].focus(),this.multiboxClose()}},moveIntoView:function(){var e=this.$(d.selector("mb_result")).filter(d.selector("highlighted"));if(e.length){var t=e.parent(),i=t.scrollTop(),s=i+t.outerHeight(),n=e.get(0).offsetTop,o=n+e.outerHeight();n<i?t.scrollTop(n-4):o>s&&t.scrollTop(o-t.outerHeight())}},multiboxClose:function(){this.removeHighlighted(),this.$(d.selector("mb_results")).removeClass(d.classes.active),this.$(d.selector("mb_input")).val("").blur(),this.isActive=!1},multiboxOpen:function(){var e=this.$(d.selector("mb_results"));e.length&&(e.hasClass(d.classes.active)||(this.removeHighlighted(),this.refreshDOM(),e.addClass(d.classes.active).scrollTop(0)),this.isActive=!0)},navigate:function(e){var t=this.$(d.selector("mb_result")+":not(:hidden)"),i=t.index(this.$(d.selector("highlighted"))),s=Math.min(i+e,t.length-1);t.removeClass(d.classes.highlighted),0>s?this.$(d.selector("mb_input")).focus():(t.eq(s).addClass(d.classes.highlighted),this.moveIntoView())},navigateDown:function(){this.multiboxOpen(),this.navigate(1)},navigateNext:function(){this.$(d.selector("highlighted")).nextUntil(":hidden").length?this.navigateDown():this.navigateUp()},navigateUp:function(){this.multiboxOpen(),this.navigate(-1)},onClickOutside:function(e){if(this.isActive){var t=this.$(e.target);t.length&&t.closest(d.selector("mb")).length||this.multiboxClose()}},onFocusInside:function(e){this.multiboxOpen()},onKeydown:function(e){var t,i=e.code.replace(/Arrow|ape/g,"");~y.indexOf(i)&&(e.stopPropagation(),null===(t=this["keydown"+i])||void 0===t||t.call(this,e))},onKeyup:function(e){var t,i=e.code.replace(/Arrow|ape/g,"");~b.indexOf(i)&&(e.stopPropagation(),null===(t=this["keyup"+i])||void 0===t||t.call(this,e))},onMouseleave:function(e){this.$(e.currentTarget).removeClass(d.classes.highlighted)},onMouseover:function(e){this.removeHighlighted(),this.$(e.currentTarget).addClass(d.classes.highlighted)},onRemove:function(e){this.removeSelected(jQuery(e.currentTarget))},onSearch:function(e){var t=this;_.debounce((function(){t.removeHighlighted(),t.refreshDOM()}),100)()},onSelect:function(e){this.selectOption(jQuery(e.currentTarget))},refreshDOM:function(){this.renderEntries(),this.filterEntries()},removeHighlighted:function(){this.$(d.selector("mb_result")).removeClass(d.classes.highlighted)},removeSelected:function(e){var t=this,i=e.data("slug");if(i){var s=_.without(this.model.get(this.key)||[],i);this.model.set(this.key,s,{silent:!0}),e.closest(d.selector("mb_entry")).css({backgroundColor:"#F1ADAD"}).fadeOut(350,(function(){t.removeHighlighted(),t.refreshDOM(),t.$(d.selector("mb_input")).focus()}))}},renderEntries:function(){var e=this,t=this.model.get(this.key)||[],i=this.$(d.selector("mb_entries"));i.html(""),_.each(t,(function(t){var s=_.findWhere(e.options,{slug:t});i.append(e.templateEntry(s||{name:t,slug:t}))}))},selectOption:function(e){var t=e.data("slug");if(t){var i=this.model.get(this.key)||[];i.push(t),i=_.uniq(i).sort(),this.model.set(this.key,i,{silent:!0,validate:!0}),this.model.trigger("model:validate:reset",e),this.navigateNext(),this.refreshDOM(),this.$(d.selector("mb_input")).val("").focus()}}}),x={},k=Backbone.View.extend({className:"glsrf-field",criteria:["conditions"],multibox:["roles","terms","users","posttypes"],template:wp.template("glsrf-field"),templates:{general:{type:"glsrf-field-type",name:"glsrf-field-name",options:"glsrf-field-options",value:"glsrf-field-value",tag:"glsrf-field-tag",roles:"glsrf-field-roles",terms:"glsrf-field-terms",users:"glsrf-field-users",posttypes:"glsrf-field-posttypes",hidden:"glsrf-field-hidden"},presentation:{label:"glsrf-field-label",description:"glsrf-field-description",placeholder:"glsrf-field-placeholder",responsive_width:"glsrf-field-responsive_width",labels:"glsrf-field-labels",tag_label:"glsrf-field-tag_label",format:"glsrf-field-format",format_link_text:"glsrf-field-format_link_text"},validation:{minlength:"glsrf-field-minlength",maxlength:"glsrf-field-maxlength",required:"glsrf-field-required"},conditions:{conditions:"glsrf-field-conditions"}},events:{"change input[type=checkbox]":"onChange","change input[type=number]":"onChange","change select":"onChange","click .template-tag":"onSelectFieldTag","click a.remove-field":"onRemoveField","click a.toggle-field":"onToggleField","click button.save-field":"onSaveField","click button[data-panel]":"onSwitchPanel",keydown:"onViewKeydown","keyup input":"onChange","keyup textarea":"onChange",keyup:"onViewKeyup"},initialize:function(){this.$el.attr("data-model-cid",this.model.cid),this.templates=wp.hooks.applyFilters("site-reviews-forms.templates",this.templates),this.listenTo(this.model,"change",this.refresh),this.listenTo(this.model,"change:hidden",this.changeHidden),this.listenTo(this.model,"change:type",this.changeType),this.listenTo(this.model,"destroy",this.remove),this.listenTo(this.model,"field:collapse",this.collapseField),this.listenTo(this.model,"field:expand",this.expandField),this.listenTo(this.model,"model:validate:reset",this.resetValidation)},render:function(){var t=this,i=this.$('button[data-panel][aria-selected="true"]').data("panel");this.$el.html(this.template(this.model.toJSON()));var s=this.$(d.selector("settings")),n=this.model.options();return _.each(this.templates,(function(i,o){var l=jQuery('<div data-panel="'.concat(o,'"/>'));s.append(l),_.each(i,(function(i,s){if(-1!==_.indexOf(n,s)){var o=_.clone(t.model.toJSON());o.formats=e.formats[o.type],o.options=function(e,t){var i=[];return _.map(e,(function(e,s){"range"===t||""===s||s===e?i.push(e):i.push(s+" : "+e)})),i.join("\n")}(o.options,o.type),l.append(wp.template(i)(o)),-1!==_.indexOf(t.multibox,s)&&t.loadMultibox(s),-1!==_.indexOf(t.criteria,s)&&t.loadCriteria(s)}}))})),this.restoreFocus(),this.renderTag(),s.append(wp.template("glsrf-field-save")),GLSR.autosize(this.$("textarea")),this.switchPanel(i),this},renderTag:function(e){var t;null!==(t=e)&&void 0!==t||(e=this.model.get("tag")),this.$(".glsrf-td-tag").html(wp.template("glsrf-tag")({tag:e}))},changeHidden:function(e){this.$el.removeClass(d.classes.invalid),e.reset()},changeType:function(e,t){this.$el.removeClass(d.classes.invalid),e.reset(t)},collapseField:function(){var e=this,t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.model.toggle(!1),this.$(d.selector("field_inner")).slideUp(200,(function(){t&&e.validate()}))},expandField:function(){var e=this;this.model.toggle(!0),this.switchPanel("general"),this.$(d.selector("field_inner")).slideDown(200,(function(){GLSR.autosize.update(e.$("textarea"))}))},loadCriteria:function(e){var t=this.$(d.selector("criteria")),i=new v({el:t,key:e,model:this.model});_.isUndefined(window.x)&&(window.x=[]),window.x.push(i)},loadMultibox:function(e){var t=this,i=this.$(d.selector("mb"));x[e]?new w({el:i,options:x[e],key:e,model:this.model}):wp.apiFetch({path:"/site-reviews/v1/forms/".concat(e)}).then((function(s){x[e]=s,new w({el:i,options:s,key:e,model:t.model})}))},onChange:function(e){if(!~["ArrowDown","ArrowUp","Tab"].indexOf(e.code)){var t=e.currentTarget,i=t.dataset.field,s={validate:!0};if(!_.isEmpty(i)){var n=t.value;~["checkbox","radio"].indexOf(t.type)&&(n="Space"===e.code?!t.checked:t.checked),~["hidden","format","type"].indexOf(i)||(s.silent=!0),~["description","label"].indexOf(i)||(n=jQuery("<div/>").html(n).text()),"options"===i?n=function(e,t){var i=e.split("\n"),s={},n=1;return _.map(i,(function(e){"range"===t?s[n++]=jQuery.trim(e):((e=e.split(":"))[1]=e[1]||e[0],s[jQuery.trim(e[0])]=jQuery.trim(e[1]))})),s}(n,this.model.get("type")):"labels"===i?n=_.map(this.$('[data-field="labels"]'),(function(e){return jQuery("<div/>").html(jQuery(e).val()).text()})):"tag"===i?(this.renderTag(n),this.model.trigger("tippy")):"responsive_width"===i&&((n=this.model.get("responsive_width"))[t.dataset.size]=t.value),this.resetValidation(t),this.model.set(i,n,s)}}},onRemoveField:function(e){e.preventDefault(),this.model.destroy()},onSaveField:function(e){this.validate()&&(this.model.trigger("field:save",this.model),this.render(),this.model.trigger("data:refresh"),this.collapseField(!1))},onSelectFieldTag:function(e){c(e.currentTarget)},onSwitchPanel:function(e){e.preventDefault(),this.switchPanel(e.currentTarget.dataset.panel)},onToggleField:function(e){e.preventDefault(),this.model.get("expanded")?this.collapseField():this.expandField()},onViewKeydown:function(e){"Enter"===e.code&&"TEXTAREA"!==e.target.nodeName&&e.preventDefault(),this.model.trigger("multibox:keydown",e)},onViewKeyup:function(e){this.model.trigger("multibox:keyup",e)},refresh:function(){this.model.toggle(!0),this.render()},resetValidation:function(e){var t=this.$(e).closest(".glsr-metabox-field");t.find(d.selector("invalid")).removeClass(d.classes.invalid),t.find(d.selector("error")).remove()},restoreFocus:function(){var e=this;_.every(["type","hidden","format"],(function(t){return!e.model.hasChanged(t)||(e.$('[data-field="'.concat(t,'"]')).focus(),!1)}))},switchPanel:function(e){var t=this;"field:switchPanel[".concat(e=e||"general","]"),this.$("button[data-panel]").each((function(i,s){s.dataset.panel===e?(t.$(s).attr("aria-selected","true"),t.$(s).attr("tabindex",-1)):(t.$(s).attr("aria-selected","false"),t.$(s).removeAttr("tabindex"))})),this.$("div[data-panel]").each((function(i,s){t.$(s)[s.dataset.panel===e?"show":"hide"](),s.childElementCount||t.$('button[data-panel="'.concat(s.dataset.panel,'"]')).hide()})),GLSR.autosize.update(this.$("textarea"))},validate:function(){var e,t=this;return _.isEmpty(this.model.errors)?(this.$el.removeClass(d.classes.invalid),!0):(this.$el.addClass(d.classes.invalid),_.each(this.model.errors,(function(i,s){var n=t.$('[data-field="'.concat(s,'"]'));e||(e=n.closest("[data-panel]").data("panel")),t.resetValidation(n),n.addClass(d.classes.invalid).closest(d.selector("input")).append(wp.template("glsrf-field-error")({error:i}))})),e&&this.switchPanel(e),!1)}}),$={Collection:a,Model:r,View:k},C=Backbone.View.extend({el:"#glsrf-metabox-fields",fields:null,sortable:null,tippy:[],events:{"click button.add-field":"createField","click button.collapse-all":"collapseFields","click button.expand-all":"expandFields"},initialize:function(){var e=this;this.fields=new $.Collection,this.listenTo(this.fields,"add",this.addField),this.listenTo(this.fields,"change",this.refresh),this.listenTo(this.fields,"tippy",this.tippyJs),this.listenTo(this.fields,"data:refresh",this.refresh),this.listenTo(this.fields,"update",this.refresh),this.listenTo(this.fields,"reset",this.addFields),jQuery(document).on("click",(function(t){return e.fields.trigger("doc:click",t)})),this.render()},render:function(){try{this.fields.add(JSON.parse(this.$("#glsrf-data").val()))}catch(e){console.error(e)}return this},addField:function(e){var t=new $.View({model:e});this.$(".glsrf-fields").append(t.render().el)},addFields:function(){this.$(".glsrf-fields").html(""),this.fields.each(this.addField,this)},collapseFields:function(e){e.currentTarget.blur(),this.fields.each((function(e){return e.trigger("field:collapse")}))},createField:function(e){e.preventDefault();var t=new $.Model;this.fields.each((function(e){return e.trigger("field:collapse")})),this.fields.add(t.reset(null,!1)),t.trigger("field:expand")},expandFields:function(e){e.currentTarget.blur(),this.fields.each((function(e){return e.trigger("field:expand")}))},refresh:function(e){this.toggleWelcome(),this.refreshData(),this.sortableUi(),this.tippyJs()},refreshData:function(){var e=[];this.fields.each((function(t){t.isValid(),_.isEmpty(t.errors)?e.push(t.toJSON()):console.error(t.errors)})),this.$("#glsrf-data").val(JSON.stringify(e))},sortableUi:function(){null===this.sortable?this.sortable=this.$(".glsrf-fields").sortable({delay:150,items:".glsrf-field",handle:".glsrf-field-handle .sortable-drag",tolerance:"pointer",scroll:!1,start:function(e,t){t.item[0].classList.add("glsrf-disable"),t.placeholder.outerHeight(t.item.outerHeight())},stop:this.sortFields.bind(this)}):this.sortable.sortable("refresh")},sortFields:function(){var e=this;this.$(".glsrf-fields").children().each((function(t,i){var s=jQuery(i).attr("data-model-cid"),n=e.fields.get(s);n&&(e.fields.remove(n,{silent:!0}),e.fields.add(n,{silent:!0,sort:!e.fields.comparator})),i.classList.remove("glsrf-disable")})),this.refreshData()},tippyJs:function(){_.each(this.tippy,(function(e){return e.destroy()})),this.tippy=GLSR.Tippy.tippy("#wpbody [data-tippy-content]",{delay:[200,null],followCursor:"horizontal",offset:[-50,10],placement:"top-start",plugins:[GLSR.Tippy.plugins.followCursor]})},toggleWelcome:function(){this.$(".glsrf-actions > div")[this.fields.length?"show":"hide"](),this.$(".glsrf-no-fields")[this.fields.length?"hide":"show"]()}});jQuery((function(e){var t=e("textarea.glsrf-template");t.length&&(wp.codeEditor.initialize(t,cm_settings),new C),e(document).on("postbox-toggled",(function(){e(".CodeMirror").each((function(e,t){return t.CodeMirror.refresh()}))})),e("code[data-select-text]").on("click",(function(e){return c(e.currentTarget)}));var i=function(t){var n=t.target,o=n.closest(".inside"),l=n.value,r=function(e,t){return s({},GLSR.nameprefix,jQuery.extend({_action:e,_nonce:GLSR.nonce[e]},t))}("metabox-details",{form_id:l,post_id:e("#post_ID").val()});wp.ajax.post(GLSR.action,r).done((function(t){GLSR.stars.destroy(),e(o).find(".glsr-metabox-field:not([data-toggle])").remove(),e(o).append(t.items),e(o).find("#site-reviews-form").val(l),e(o).find("#site-reviews-form").on("change",i),GLSR.stars.rebuild()}))};e("select#site-reviews-form").on("change",i)}))}();